---
import BlogCard from "@/components/BlogCard.astro";
import Share from "@/components/Share.astro";
import GiscusComments from "@/helpers/Giscus";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similarItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { render } from "astro:content";
import { FaRegClock, FaRegFolder, FaRegUserCircle } from "react-icons/fa";
import ImageMod from "./components/ImageMod.astro";

const COLLECTION_FOLDER = "blog";
const { post } = Astro.props;

const posts = await getSinglePage(COLLECTION_FOLDER);
const similarPosts = similarItems(post, posts);
const { Content } = await render(post);
const { title, description, author, categories, image, date, tags } = post.data;
---

<section class="section pt-7">
  <div class="container">
    <!-- Mobile ToC Button -->
    <button
      id="mobile-toc-btn"
      class="lg:hidden fixed bottom-6 right-6 z-40 bg-primary text-white dark:bg-darkmode-primary dark:text-text-dark rounded-full p-4 shadow-lg hover:scale-110 transition-transform"
      aria-label="Toggle Table of Contents"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
      </svg>
    </button>

    <div class="row justify-center">
       <article class="lg:col-8">
        {
          image && (
            <div class="mb-10">
              <ImageMod
                src={image}
                height={500}
                width={1200}
                alt={title}
                class="w-full rounded"
                format="webp"
              />
            </div>
          )
        }
        <h1 set:html={markdownify(title)} class="h2 mb-4" />
        <ul class="mb-4">
          <li class="mr-4 inline-block">
            <a href={`/authors/${slugify(author)}`}>
              <FaRegUserCircle className={"mr-2 -mt-1 inline-block"} />
              {humanize(author)}
            </a>
          </li>
          <li class="mr-4 inline-block">
            <FaRegFolder className={"mr-2 -mt-1 inline-block"} />
            {
              categories.map((category: string, index: number) => (
                <a href={`/categories/${slugify(category)}`}>
                  {humanize(category)}
                  {index !== categories.length - 1 && ","}
                </a>
              ))
            }
          </li>
          <li class="mr-4 inline-block">
            <FaRegClock className={"mr-2 -mt-1 inline-block"} />
            {dateFormat(date)}
          </li>
        </ul>
        <div class="content mb-10">
          <Content />
        </div>
        <div class="row items-center justify-between">
          <div class="mb-10 flex items-center lg:col-7 lg:mb-0">
            <h5 class="mr-3 whitespace-nowrap">Tags:</h5>
            <ul>
              {
                tags.map((tag: string) => (
                  <li class="inline-block">
                    <a
                      class="m-1 block rounded bg-light px-3 py-1 hover:bg-primary hover:text-white dark:bg-darkmode-light dark:hover:bg-darkmode-primary dark:hover:text-text-dark"
                      href={`/tags/${slugify(tag)}`}
                    >
                      {humanize(tag)}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
          <div class="flex items-center lg:col-5">
            <h5 class="mr-3 whitespace-nowrap">Share:</h5>
            <Share
              className="social-icons"
              title={title}
              description={description}
              slug={post.id}
            />
          </div>
         </div>
         <GiscusComments className="mt-20" client:load />
       </article>
       
       <!-- ToC Sidebar -->
       <aside class="lg:col-4" id="toc-sidebar">
         <!-- Desktop ToC -->
         <div class="hidden lg:block sticky top-16 max-h-[calc(100vh-9rem)] overflow-y-auto pt-4">
           <h5 class="mt-4 mb-4 text-lg font-semibold">Table of Contents</h5>
           <nav id="toc" class="toc"></nav>
         </div>
         
         <!-- Mobile ToC Panel -->
         <div id="mobile-toc-panel" class="lg:hidden fixed right-0 top-0 h-full w-80 bg-body dark:bg-darkmode-body z-50 transform translate-x-full transition-transform duration-300 shadow-xl overflow-y-auto">
           <div class="p-6">
             <div class="flex justify-between items-center mb-4">
               <h5 class="text-lg font-semibold">Table of Contents</h5>
               <button id="close-toc" class="text-2xl" aria-label="Close Table of Contents">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                 </svg>
               </button>
             </div>
             <nav id="toc-mobile" class="toc"></nav>
           </div>
         </div>
         
         <!-- Mobile ToC Overlay -->
         <div id="toc-overlay" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
       </aside>
      </div>
      <script>
       import tocbot from 'tocbot';
       import 'tocbot/dist/tocbot.css';

       // Mark paragraphs that only contain math (for proper centering)
       function markMathOnlyParagraphs() {
         const contentDiv = document.querySelector('.content');
         if (!contentDiv) return;

         const paragraphs = contentDiv.querySelectorAll('p');
         paragraphs.forEach((p) => {
           // Get all child nodes
           const children = Array.from(p.childNodes);
           
           // Check if paragraph has exactly one element child and it's an mjx-container
           const elementChildren = children.filter(node => node.nodeType === Node.ELEMENT_NODE) as Element[];
           const mjxContainer = elementChildren.find(el => el.tagName === 'MJX-CONTAINER');
           
           // Get all text nodes and check if they're only whitespace
           const textNodes = children.filter(node => node.nodeType === Node.TEXT_NODE);
           const hasNonWhitespaceText = textNodes.some(node => node.textContent?.trim());
           
           // Mark as math-only if: has exactly 1 mjx-container, no other elements, and no non-whitespace text
           if (elementChildren.length === 1 && mjxContainer && !hasNonWhitespaceText) {
             p.classList.add('math-only');
           }
           p.classList.add('math-checked');
         });
       }

       function closeTocPanel() {
         const tocPanel = document.getElementById('mobile-toc-panel');
         const tocOverlay = document.getElementById('toc-overlay');
         if (tocPanel && tocOverlay) {
           tocPanel.classList.add('translate-x-full');
           tocOverlay.classList.add('hidden');
           document.body.style.overflow = '';
         }
       }

       function initToc() {
         // Destroy any existing instances first
         tocbot.destroy();

         const commonConfig = {
           contentSelector: '.content',
           headingSelector: 'h2, h3',
           scrollSmooth: true,
           scrollSmoothDuration: 200,
           headingsOffset: 140,
           scrollSmoothOffset: -140,
           throttleTimeout: 200,
         };

         // Wait a bit for content to be fully rendered
         requestAnimationFrame(() => {
           // Initialize desktop ToC
           if (window.innerWidth >= 1024) {
             tocbot.init({
               ...commonConfig,
               tocSelector: '#toc',
             });
           } else {
             // Initialize mobile ToC
             tocbot.init({
               ...commonConfig,
               tocSelector: '#toc-mobile',
             });
             
             // Add click handlers to mobile ToC links after they're created
             setTimeout(() => {
               const tocLinks = document.querySelectorAll('#toc-mobile a');
               tocLinks.forEach(link => {
                 link.addEventListener('click', () => {
                   setTimeout(closeTocPanel, 300);
                 });
               });
             }, 100);
           }
         });
       }

       function initTocToggle() {
         const mobileBtn = document.getElementById('mobile-toc-btn');
         const tocPanel = document.getElementById('mobile-toc-panel');
         const tocOverlay = document.getElementById('toc-overlay');
         const closeBtn = document.getElementById('close-toc');

         if (!mobileBtn || !tocPanel || !tocOverlay || !closeBtn) return;

         function openToc() {
           if (tocPanel && tocOverlay) {
             tocPanel.classList.remove('translate-x-full');
             tocOverlay.classList.remove('hidden');
             document.body.style.overflow = 'hidden';
           }
         }

         mobileBtn.addEventListener('click', openToc);
         closeBtn.addEventListener('click', closeTocPanel);
         tocOverlay.addEventListener('click', closeTocPanel);
       }

        // Initialize on page load
        initToc();
        initTocToggle();
        
        // Mark math-only paragraphs after a short delay to ensure MathJax has rendered
        setTimeout(markMathOnlyParagraphs, 100);

        // Re-initialize on client-side navigation (for Astro view transitions)
        document.addEventListener('astro:page-load', () => {
          initToc();
          initTocToggle();
          setTimeout(markMathOnlyParagraphs, 100);
        });

       // Re-initialize on window resize
       let resizeTimer: ReturnType<typeof setTimeout>;
       window.addEventListener('resize', () => {
         clearTimeout(resizeTimer);
         resizeTimer = setTimeout(initToc, 250);
       });
     </script>

     <!-- Related posts -->
    <div class="section pb-0">
      <h2 class="h3 mb-12 text-center">Related Posts</h2>
      <div class="row justify-center">
        {
          similarPosts.map((post) => (
            <div class="lg:col-4 md:col-6 mb-14">
              <BlogCard data={post} />
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>
